<script>
  const GSHEET_API = "/api/gsheet-proxy";
</script>
<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Lucky Racer</title>
    <link rel="stylesheet" href="style.css?v=45" />
  </head>
  <body>
    <!-- Login Modal -->
    <!-- <div id="loginModal" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;">
        <div style="background:#222;padding:32px 24px 24px 24px;border-radius:12px;box-shadow:0 4px 32px #0006;min-width:320px;max-width:90vw;">
            <h2 style="color:#fff;text-align:center;margin-bottom:18px;">ÄÄƒng nháº­p Ä‘á»ƒ vÃ o Lucky Racer</h2>
            <div style="display:flex;flex-direction:column;gap:12px;">
                <input id="loginUsername" type="text" placeholder="Nháº­p tÃªn Ä‘Äƒng nháº­p" style="padding:10px 12px;border-radius:6px;border:1px solid #888;font-size:16px;outline:none;">
                <div style="display:flex;align-items:center;gap:8px;">
                    <input id="loginPassword" type="password" placeholder="Nháº­p máº­t kháº©u" style="padding:10px 12px;border-radius:6px;border:1px solid #888;font-size:16px;outline:none;flex:1;">
                    <label style="color:#fff;font-size:13px;cursor:pointer;user-select:none;">
                        <input type="checkbox" id="showLoginPassword" style="margin-right:2px;"> Hiá»‡n
                    </label>
                </div>
                <label style="color:#fff;font-size:15px;display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" id="isAdmin" style="width:16px;height:16px;"> ÄÄƒng nháº­p vá»›i quyá»n admin
                </label>
                <button id="loginBtn" style="padding:10px 0;border-radius:6px;background:#667eea;color:#fff;font-size:16px;border:none;cursor:pointer;position:relative;">ÄÄƒng nháº­p
                    <span id="loginLoadingSpinner" style="display:none;position:absolute;right:16px;top:50%;transform:translateY(-50%);">
                        <span class="loading-spinner" style="width:22px;height:22px;border-width:3px;margin:0;"></span>
                    </span>
                </button>
                <div id="loginError" style="color:#ff7675;text-align:center;display:none;font-size:14px;">Vui lÃ²ng nháº­p tÃªn Ä‘Äƒng nháº­p!</div>
            </div>
        </div>
    </div> -->
    <!-- Remove tab navigation, keep single page -->
    <!-- <div class="container" id="mainContent" style="display:none;"> -->
    <div class="container" id="mainContent">
      <!-- Chá»©c nÄƒng admin: generate máº­t kháº©u -->
      <div id="adminPanel" style="display: none; margin-bottom: 24px">
        <h3 style="color: #ffd700">ğŸ”‘ Admin Panel</h3>
        <button
          id="genPassBtn"
          style="
            padding: 8px 18px;
            border-radius: 6px;
            background: #e17055;
            color: #fff;
            font-size: 16px;
            border: none;
            cursor: pointer;
          "
        >
          Táº¡o máº­t kháº©u ngáº«u nhiÃªn
        </button>
        <div
          id="genPassResult"
          style="
            margin-top: 10px;
            color: #00b894;
            font-size: 18px;
            font-weight: bold;
          "
        ></div>
        <form
          id="addAccountForm"
          style="
            margin-top: 18px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
          "
        >
          <input
            id="newUsername"
            type="text"
            placeholder="TÃªn Ä‘Äƒng nháº­p má»›i"
            style="
              padding: 6px 10px;
              border-radius: 5px;
              border: 1px solid #888;
              min-width: 120px;
            "
          />
          <div style="display: flex; align-items: center; gap: 8px">
            <input
              id="newPassword"
              type="password"
              placeholder="Máº­t kháº©u má»›i"
              style="
                padding: 6px 10px;
                border-radius: 5px;
                border: 1px solid #888;
                min-width: 120px;
              "
            />
            <label
              style="
                color: #fff;
                font-size: 13px;
                cursor: pointer;
                user-select: none;
              "
            >
              <input
                type="checkbox"
                id="showNewPassword"
                style="margin-right: 2px"
              />
              Hiá»‡n
            </label>
          </div>
          <input
            id="activeTime"
            type="datetime-local"
            style="
              padding: 6px 10px;
              border-radius: 5px;
              border: 1px solid #888;
            "
          />
          <input
            id="revokeTime"
            type="datetime-local"
            style="
              padding: 6px 10px;
              border-radius: 5px;
              border: 1px solid #888;
            "
          />
          <button
            type="submit"
            style="
              padding: 6px 14px;
              border-radius: 5px;
              background: #00b894;
              color: #fff;
              border: none;
            "
          >
            ThÃªm tÃ i khoáº£n
          </button>
        </form>
        <div
          id="accountList"
          style="margin-top: 16px; color: #fff; font-size: 15px"
        ></div>
      </div>
      <h1>The Lucky Racer - Settings</h1>

      <!-- Loading Indicator -->
      <div class="loading-container" id="loadingContainer">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading icons...</div>
        <div class="loading-progress" id="loadingProgress">0%</div>
      </div>

      <!-- Game Settings -->
      <div class="settings-panel" id="settingsPanel">
        <h2>Race Settings</h2>

        <!-- Simplified Prize Setup (Top Priority) -->
        <div
          style="
            padding: 20px;
            margin-bottom: 20px;
            background: rgba(255, 215, 0, 0.15);
            border: 2px solid #ffd700;
            border-radius: 8px;
          "
        >
          <h3 style="color: #ffd700; margin: 0 0 15px 0; font-size: 18px">
            ğŸ† Táº¡o Script Äua
          </h3>
          <div style="display: flex; gap: 10px; margin-bottom: 12px">
            <input
              type="text"
              id="simplePrizeName"
              placeholder="TÃªn giáº£i (VD: Giáº£i Nháº¥t)"
              style="
                flex: 2;
                padding: 12px;
                background: #222;
                color: white;
                border: 1px solid #444;
                border-radius: 5px;
                font-size: 14px;
              "
            />
            <input
              type="number"
              id="simplePrizeCount"
              value="1"
              min="1"
              placeholder="Sá»‘ ngÆ°á»i"
              style="
                flex: 1;
                padding: 12px;
                background: #222;
                color: white;
                border: 1px solid #444;
                border-radius: 5px;
                max-width: 100px;
                font-size: 14px;
              "
            />
            <button
              class="btn"
              onclick="game.addRaceScript()"
              style="
                background: #27ae60;
                padding: 12px 20px;
                margin: 0;
                font-size: 14px;
                white-space: nowrap;
              "
            >
              + Táº¡o Script
            </button>
          </div>
          <div
            id="raceScriptsList"
            style="
              background: rgba(0, 0, 0, 0.4);
              border-radius: 5px;
              padding: 12px;
              min-height: 60px;
              color: white;
              font-size: 13px;
              max-height: 300px;
              overflow-y: auto;
              border: 1px solid #444;
            "
          >
            <i style="color: #888">ChÆ°a cÃ³ script nÃ o Ä‘Æ°á»£c táº¡o...</i>
          </div>
          <small style="color: #888; display: block; margin-top: 8px">
            ğŸ’¡ Má»—i script = 1 láº§n Ä‘ua. Nháº¥n START Ä‘á»ƒ cháº¡y Ä‘ua vá»›i giáº£i Ä‘Ã³
          </small>
        </div>

        <div class="input-group">
          <label for="duckCount">Number of Racers:</label>
          <input
            type="number"
            id="duckCount"
            min="10"
            max="10000"
            value="300"
          />
        </div>
        <div class="input-group">
          <label for="raceDuration">Race Duration (seconds):</label>
          <input type="number" id="raceDuration" min="5" max="300" value="30" />
        </div>

        <!-- <div class="input-group">
          <label for="gameSpeed"
            >Game Speed: <span id="gameSpeedValue">1.0x</span></label
          >
          <input
            type="range"
            id="gameSpeed"
            min="0.25"
            max="3"
            step="0.25"
            value="1"
            oninput="
              document.getElementById('gameSpeedValue').textContent =
                this.value + 'x';
              if (window.game) game.updateGameSpeed(parseFloat(this.value));
            "
          />
          <small style="color: #888"
            >Adjust race speed: 0.25x (slow motion) to 3x (fast forward)</small
          >
        </div>

        <!-- <div class="input-group">
          <label for="duckSizeRatio"
            >Duck Size: <span id="duckSizeValue">50%</span></label
          >
          <input
            type="range"
            id="duckSizeRatio"
            min="10"
            max="100"
            value="50"
            step="1"
            oninput="
              document.getElementById('duckSizeValue').textContent =
                this.value + '%'
            "
          />
          <button
            id="applyDuckSizeBtn"
            type="button"
            style="margin-left: 12px; vertical-align: middle"
            onclick="
              if (window.game) {
                var val = document.getElementById('duckSizeRatio').value;
                game.setDuckSizeRatio(parseFloat(val));
                game.forceUpdateDuckSize && game.forceUpdateDuckSize();
                // Gá»­i sang display luÃ´n, khÃ´ng cáº§n kiá»ƒm tra displayReady
                var ratio = parseFloat(val) / 100;
                if (game.displayChannel) {
                  game.displayChannel.postMessage({
                    type: 'UPDATE_DUCK_SIZE',
                    duckSizeRatio: ratio,
                  });
                  console.log(
                    '[DuckSize][control] Sent UPDATE_DUCK_SIZE to display:',
                    ratio,
                  );
                }
              }
            "
          >
            Apply
          </button>
          <small style="color: #888"
            >Adjust duck icon size relative to track height (10%â€“100%).</small
          >
        </div> -->

        <div class="input-group">
          <!-- Race Mode selection removed: now auto by number of winners -->
        </div>

        <!-- <div class="input-group">
          <label for="finishSafeZone"
            >Finish Safe Zone (px):
            <span id="finishSafeZoneValue">0px</span></label
          >
          <input
            type="range"
            id="finishSafeZone"
            min="0"
            max="300"
            step="5"
            value="0"
            oninput="
              document.getElementById('finishSafeZoneValue').textContent =
                this.value + 'px';
              if (window.game) game.setFinishSafeZone(parseInt(this.value, 10));
            "
          />
          <small style="color: #888"
            >Pixels near finish where lane switching is disabled (reduces jumpy
            lane changes).</small
          >
        </div>

        <div class="input-group">
          <label for="finishStaggerToggle">Enable Finish Stagger:</label>
          <input
            type="checkbox"
            id="finishStaggerToggle"
            onchange="
              if (window.game) game.setFinishStaggerEnabled(this.checked);
            "
          />
          <small style="color: #888"
            >Toggle vertical staggering of finishers to reduce overlap. Leave
            unchecked to allow natural finishing (default).</small
          >
        </div>
        <div class="input-group">
          <button
            class="btn"
            onclick="game.showCurrentSettings()"
            style="background: #27ae60; width: 100%; margin-top: 10px"
          >
            ğŸ“‹ Show Current Settings
          </button>
        </div> -->

        <!-- Number of Winners: Hidden, auto-calculated from prizes -->
        <!-- <div class="input-group" style="display: none">
          <label for="winnerCount">Number of Winners:</label>
          <input
            type="number"
            id="winnerCount"
            min="1"
            max="50"
            value="3"
            onchange="
              if (window.game) {
                game.handleWinnerCountChange &&
                  game.handleWinnerCountChange(this.value);
              } else {
                if (game) game.toggleRaceMode();
              }
            "
          />
          <small style="color: #888"
            >Set 1 for Normal mode, >1 for Top N mode</small
          >
        </div> -->

        <div class="input-group">
          <label for="duckNamesFile" id="fileLabel"
            >Racer List File (CSV/Excel):</label
          >
          <div style="display: flex; gap: 10px; align-items: center">
            <input
              type="file"
              id="duckNamesFile"
              accept=".csv,.xlsx,.xls"
              onchange="game.loadDuckNames(event)"
              style="flex: 1"
            />
            <button
              onclick="game.clearLoadedFile()"
              id="clearFileBtn"
              class="btn btn-warning"
              style="display: none; padding: 8px 16px"
            >
              ğŸ—‘ï¸ Clear
            </button>
          </div>
          <small style="color: #888" id="fileHelp"
            >Upload CSV/Excel to use custom names, or leave empty for random
            names</small
          >
        </div>
        <div class="input-group">
          <label for="iconTheme">Icon Theme:</label>
          <select id="iconTheme" onchange="game.changeIconTheme()">
            <option value="output_1">Theme 1</option>
            <option value="output_2">Theme 2</option>
          </select>
          <small style="color: #888" id="iconCount">0 icon</small>
        </div>
        <div class="input-group">
          <label for="soundToggle">
            <input type="checkbox" id="soundToggle" checked /> Enable Sound
          </label>
        </div>

        <!-- <div class="input-group">
          <label for="forceClusterToggle">
            <input
              type="checkbox"
              id="forceClusterToggle"
              onchange="
                if (window.game) game.setForceClusterCamera(this.checked);
              "
            />
            <strong>Force Cluster Camera</strong>
          </label>
          <small style="color: #888"
            >When enabled, camera will focus on densest pack (useful for
            testing)</small
          >
        </div> -->
        <div class="input-group">
          <label for="customSoundFile">Custom Race Sound (MP3):</label>
          <input
            type="file"
            id="customSoundFile"
            accept=".mp3,.wav,.ogg"
            style="width: 100%; padding: 5px"
          />
          <small style="color: #888"
            >Optional: Upload custom racing ambiance sound</small
          >
        </div>
        <div
          class="main-panel-background-settings"
          style="font-size: 14px; color: #fff; margin: 20px 0 10px 0"
        >
          Background Settings

          <div
            style="
              margin-top: 15px;
              padding: 10px;
              background: rgba(102, 126, 234, 0.1);
              border-radius: 5px;
            "
          >
            <h4 style="color: #667eea; font-size: 16px; margin: 0 0 10px 0">
              ğŸ“ Layout Settings
            </h4>
            <div
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px"
            >
              <div style="display: flex; flex-direction: column; gap: 5px">
                <label style="font-size: 14px; color: #fff"
                  >Race Track Aspect Ratio:</label
                >
                <input
                  type="text"
                  id="raceTrackAspectRatio"
                  value="20:5"
                  placeholder="e.g., 16:9, 30:9, 21:9"
                  style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.3);
                    border: 1px solid #667eea;
                    border-radius: 5px;
                    color: #fff;
                    font-size: 14px;
                  "
                  oninput="validateAspectRatioInput(this)"
                />
                <small style="color: #888; font-size: 12px"
                  >Format: width:height (e.g., 16:9, 30:9)</small
                >
              </div>
              <!-- <div style="display: flex; flex-direction: column; gap: 5px">
                    <label style="font-size: 14px; color: #fff"
                      >Winners Grid Width:</label
                    >
                    <div style="display: flex; align-items: center; gap: 8px">
                      <input
                        type="range"
                        id="winnersGridWidth"
                        min="70"
                        max="100"
                        value="95"
                        style="flex: 1"
                      />
                      <span
                        id="winnersGridWidthValue"
                        style="min-width: 40px; font-size: 14px; color: #667eea"
                        >95%</span
                      >
                    </div>
                  </div> -->

              <!-- <div style="display: flex; flex-direction: column; gap: 5px">
                    <label style="font-size: 14px; color: #fff"
                      >Card Gap:</label
                    >
                    <div style="display: flex; align-items: center; gap: 8px">
                      <input
                        type="range"
                        id="cardGap"
                        min="0.5"
                        max="3"
                        step="0.5"
                        value="1.5"
                        style="flex: 1"
                      />
                      <span
                        id="cardGapValue"
                        style="min-width: 40px; font-size: 14px; color: #667eea"
                        >1.5%</span
                      >
                    </div>
                  </div> -->
            </div>
          </div>
          <div class="input-group" style="margin-top: 20px">
            <a
              href="display.html"
              target="_blank"
              class="btn btn-secondary"
              id="openDisplayBtn"
              style="
                width: 100%;
                margin-bottom: 10px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                pointer-events: none;
                opacity: 0.5;
              "
            >
              â³ Loading Icons...
            </a>
            <small style="color: #ffd700; font-weight: bold">ğŸ“º </small><br />
            <small style="color: #888"></small>
          </div>
        </div>
        <!-- end game settings -->

        <!-- Result Panel Preview - Independent -->
        <div class="result-panel" id="resultPanel" style="margin-top: 30px">
          <h2 id="resultTitle">Results</h2>
          <div id="resultMessage"></div>
        </div>

        <script>
          // Update slider values display
          document
            .getElementById("winnersGridWidth")
            .addEventListener("input", (e) => {
              document.getElementById("winnersGridWidthValue").textContent =
                e.target.value + "%";
            });
          document.getElementById("cardGap").addEventListener("input", (e) => {
            document.getElementById("cardGapValue").textContent =
              e.target.value + "%";
          });

          // Validate aspect ratio input format
          function validateAspectRatioInput(input) {
            const value = input.value.trim();
            // Allow digits, colon, and spaces
            const cleaned = value.replace(/[^0-9:]/g, "");
            if (cleaned !== value) {
              input.value = cleaned;
            }

            // Check if format is valid (e.g., "16:9", "30:9")
            const match = cleaned.match(/^(\d+):(\d+)$/);
            if (match) {
              input.style.borderColor = "#667eea";
              input.style.background = "rgba(0,0,0,0.3)";
            } else if (cleaned.length > 0) {
              input.style.borderColor = "#ff6b6b";
              input.style.background = "rgba(255,107,107,0.1)";
            } else {
              input.style.borderColor = "#667eea";
              input.style.background = "rgba(0,0,0,0.3)";
            }
          }
        </script>

        <!-- Race Info (for control window) -->
        <div
          class="race-info"
          id="raceInfo"
          style="margin-top: 20px; position: relative"
        >
          <div class="info-item">
            <span class="label">Race:</span>
            <span id="raceNumber" class="value">#1</span>
          </div>
          <div class="info-item">
            <span class="label">Time Left:</span>
            <span id="timeLeft" class="value">30s</span>
          </div>
          <div class="info-item">
            <span class="label">Status:</span>
            <span id="raceStatus" class="value">Waiting</span>
          </div>
        </div>

        <!-- Control Panel (for control window) -->
        <div
          class="control-panel"
          id="controlPanel"
          style="
            margin-top: 20px;
            position: relative;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
          "
        >
          <button class="btn btn-small" onclick="game.goHome()" id="homeBtn">
            ğŸ  Home
          </button>
          <button
            class="btn btn-small"
            onclick="game.controlStartRace()"
            id="controlStartBtn"
            disabled
          >
            Loading...
          </button>
          <button
            class="btn btn-small"
            onclick="game.pauseRace()"
            id="pauseBtn"
          >
            â¸ Pause
          </button>
          <button
            class="btn btn-small"
            onclick="game.resumeRace()"
            id="resumeBtn"
            disabled
          >
            â–¶ Resume
          </button>
          <button
            class="btn btn-primary"
            onclick="game.continueRace()"
            id="continueBtn"
            style="display: none"
          >
            ğŸ¯ Next Race
          </button>
          <button
            class="btn btn-secondary"
            onclick="game.showWinnersPanel()"
            id="viewResultsBtn"
          >
            ğŸ“‹ View Results
          </button>
        </div>
        <!-- end control panel -->
      </div>
      <!-- end main container -->

      <!-- Toast Notification Container -->
      <div
        id="toastContainer"
        style="
          position: fixed;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          z-index: 10000;
          display: flex;
          flex-direction: column;
          gap: 10px;
          pointer-events: none;
        "
      ></div>
      <!-- end toast notification container -->

      <!-- Victory Popup (outside container for max z-index) -->
      <div class="victory-popup" id="victoryPopup">
        <div class="victory-overlay" onclick="game.closeVictoryPopup()"></div>
        <div class="victory-content">
          <div class="victory-header">
            <h1>ğŸ‰ VICTORY! ğŸ‰</h1>
          </div>
          <div class="victory-body">
            <div class="winner-icon" id="winnerIcon"></div>
            <h2 class="winner-name" id="winnerName">Winner Name</h2>
            <div class="winner-stats" id="winnerStats"></div>
          </div>
          <div class="victory-footer" style="display: none">
            <button class="btn btn-primary" onclick="game.continueRace()">
              ğŸ¯ Continue (Next Race)
            </button>
            <button
              class="btn btn-secondary"
              onclick="
                game.closeVictoryPopup();
                game.showWinnersPanel();
              "
            >
              ğŸ“‹ View Results
            </button>
          </div>
        </div>
      </div>
      <!-- end victory popup -->
      <!-- Result Panel Settings - Collapsible -->
      <div class="result-panel-settings" style="margin-top: 30px">
        <div
          style="
            margin-top: 30px;
            border-top: 2px solid rgba(255, 255, 255, 0.2);
            padding-top: 20px;
          "
        >
          <div style="display: flex; justify-content: center">
            <button
              class="btn btn-small"
              onclick="game.toggleResultPanelSettings()"
              style="background: #bde410; width: auto"
            >
              âš™ï¸ CÃ i Ä‘áº·t hiá»ƒn thá»‹ káº¿t quáº£
            </button>
          </div>

          <div
            id="resultPanelSettingsContainer"
            style="
              margin-top: 15px;
              padding: 15px;
              background: rgba(102, 126, 234, 0.1);
              border-radius: 8px;
            "
          >
            <div
              class="main-panel-prize-settings"
              style="font-size: 14px; color: #fff; margin-bottom: 10px"
            >
              <div class="input-group">
                <label for="prizeTitleInput">TiÃªu Ä‘á» giáº£i thÆ°á»Ÿng:</label>
                <input
                  type="text"
                  id="prizeTitleInput"
                  placeholder="Káº¿t quáº£ giáº£i thÆ°á»Ÿng"
                  value="Káº¿t quáº£ giáº£i thÆ°á»Ÿng"
                  maxlength="50"
                  style="
                    padding: 8px;
                    border-radius: 5px;
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    background: rgba(0, 0, 0, 0.3);
                    color: white;
                    width: 100%;
                  "
                />
                <small style="color: #888"
                  >This will appear on result panel and popup</small
                >
              </div>

              <!-- Race Prize Settings: Hidden, using simplified version above -->
              <div
                class="main-panel-prize-settings"
                style="
                  display: none;
                  margin-top: 15px;
                  padding: 10px;
                  background: rgba(255, 215, 0, 0.1);
                  border: 1px solid #ffd700;
                  border-radius: 5px;
                "
              >
                <h4 style="color: #ffd700; font-size: 16px; margin: 0 0 10px 0">
                  ğŸ CÃ i Ä‘áº·t Giáº£i thÆ°á»Ÿng cho Cuá»™c Ä‘ua (Race)
                </h4>

                <!-- Prize Group Input -->
                <div
                  style="
                    background: rgba(0, 0, 0, 0.3);
                    padding: 12px;
                    border-radius: 5px;
                    margin-bottom: 10px;
                  "
                >
                  <div style="display: flex; gap: 8px; margin-bottom: 8px">
                    <input
                      type="text"
                      id="prizeGroupName"
                      placeholder="TÃªn giáº£i (VD: Giáº£i Khuyáº¿n KhÃ­ch)"
                      style="
                        flex: 2;
                        padding: 8px;
                        background: #222;
                        color: white;
                        border: 1px solid #444;
                        border-radius: 3px;
                      "
                    />
                    <input
                      type="number"
                      id="prizeGroupCount"
                      placeholder="Sá»‘ ngÆ°á»i"
                      min="1"
                      value="1"
                      style="
                        flex: 1;
                        padding: 8px;
                        background: #222;
                        color: white;
                        border: 1px solid #444;
                        border-radius: 3px;
                        max-width: 100px;
                      "
                    />
                    <button
                      class="btn btn-small"
                      onclick="game.addPrizeGroup()"
                      style="
                        background: #27ae60;
                        padding: 8px 15px;
                        font-size: 13px;
                        white-space: nowrap;
                      "
                    >
                      + ThÃªm nhÃ³m giáº£i
                    </button>
                  </div>
                  <small style="color: #888; display: block">
                    ğŸ’¡ VD: "Giáº£i Khuyáº¿n KhÃ­ch" + 30 ngÆ°á»i â†’ táº¡o 30 giáº£i cÃ¹ng tÃªn
                  </small>
                </div>

                <!-- Prize List -->
                <div
                  id="prizeNamesRaceContainer"
                  style="
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    max-height: 250px;
                    overflow-y: auto;
                  "
                >
                  <!-- Prize fields for race will be dynamically added here -->
                </div>
                <div style="margin-top: 10px; display: flex; gap: 5px">
                  <button
                    class="btn btn-small"
                    onclick="game.clearAllPrizes()"
                    style="
                      background: #c0392b;
                      padding: 5px 10px;
                      font-size: 12px;
                    "
                  >
                    ğŸ—‘ï¸ XÃ³a táº¥t cáº£
                  </button>
                  <button
                    class="btn btn-small"
                    onclick="game.showRacePrizes()"
                    style="
                      background: #27ae60;
                      padding: 5px 10px;
                      font-size: 12px;
                    "
                  >
                    ğŸ“‹ Show Race Prizes
                  </button>
                  <button
                    class="btn btn-small"
                    onclick="game.applyPrizeRace()"
                    style="
                      background: #2980b9;
                      padding: 5px 10px;
                      font-size: 12px;
                    "
                  >
                    âœ“ Apply Race Prizes
                  </button>
                </div>

                <!-- Race Prizes Display (Toggle) -->
                <div
                  id="racePrizesDisplay"
                  style="
                    display: none;
                    margin-top: 10px;
                    padding: 10px;
                    background: rgba(0, 0, 0, 0.4);
                    border-radius: 5px;
                    border: 1px solid #ffd700;
                    max-height: 200px;
                    overflow-y: auto;
                  "
                >
                  <div
                    style="
                      color: #ffd700;
                      font-weight: bold;
                      margin-bottom: 5px;
                    "
                  >
                    ğŸ† Race Prizes List:
                  </div>
                  <div
                    id="racePrizesContent"
                    style="color: #fff; font-size: 13px; line-height: 1.6"
                  ></div>
                </div>

                <small style="color: #888; margin-top: 8px; display: block"
                  >* Giáº£i thÆ°á»Ÿng nÃ y sáº½ hiá»‡n trÃªn Pop-up VICTORY ngay khi vá»‹t
                  vá»«a cháº¡m Ä‘Ã­ch.</small
                >
              </div>

              <!-- Result Prize Assignment Settings -->
              <div
                class="main-panel-prize-settings"
                style="
                  margin-top: 15px;
                  padding: 10px;
                  background: rgba(102, 126, 234, 0.1);
                  border: 1px solid #667eea;
                  border-radius: 5px;
                "
              >
                <h4 style="color: #667eea; font-size: 16px; margin: 0 0 10px 0">
                  ğŸ“Š GÃ¡n Giáº£i thÆ°á»Ÿng cho Káº¿t quáº£ (Result)
                </h4>

                <!-- Prize Group Input for Result -->
                <div
                  style="
                    background: rgba(0, 0, 0, 0.3);
                    padding: 12px;
                    border-radius: 5px;
                    margin-bottom: 10px;
                  "
                >
                  <div style="display: flex; gap: 8px; margin-bottom: 8px">
                    <input
                      type="text"
                      id="prizeResultGroupName"
                      placeholder="TÃªn giáº£i (VD: Giáº£i Khuyáº¿n KhÃ­ch)"
                      style="
                        flex: 2;
                        padding: 8px;
                        background: #222;
                        color: white;
                        border: 1px solid #444;
                        border-radius: 3px;
                      "
                    />
                    <input
                      type="number"
                      id="prizeResultGroupCount"
                      placeholder="Sá»‘ ngÆ°á»i"
                      min="1"
                      value="1"
                      style="
                        flex: 1;
                        padding: 8px;
                        background: #222;
                        color: white;
                        border: 1px solid #444;
                        border-radius: 3px;
                        max-width: 100px;
                      "
                    />
                    <button
                      class="btn btn-small"
                      onclick="game.addPrizeResultGroup()"
                      style="
                        background: #8e44ad;
                        padding: 8px 15px;
                        font-size: 13px;
                        white-space: nowrap;
                      "
                    >
                      + ThÃªm nhÃ³m giáº£i
                    </button>
                  </div>
                  <small style="color: #888; display: block">
                    ğŸ’¡ Táº¡o nhiá»u hÃ ng gÃ¡n giáº£i cÃ¹ng tÃªn má»™t lÃºc
                  </small>
                </div>

                <div
                  id="prizeAssignmentResultContainer"
                  style="
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                    max-height: 250px;
                    overflow-y: auto;
                  "
                >
                  <!-- Prize assignment fields will be dynamically added here -->
                </div>
                <div style="margin-top: 10px; display: flex; gap: 5px">
                  <button
                    class="btn btn-small"
                    onclick="game.clearAllResultAssignments()"
                    style="
                      background: #c0392b;
                      padding: 5px 10px;
                      font-size: 12px;
                    "
                  >
                    ğŸ—‘ï¸ XÃ³a táº¥t cáº£
                  </button>
                  <button
                    class="btn btn-small"
                    onclick="game.showPrizeAssignments()"
                    style="
                      background: #27ae60;
                      padding: 5px 10px;
                      font-size: 12px;
                    "
                  >
                    ğŸ“‹ Show Assignments
                  </button>
                  <button
                    class="btn btn-small"
                    onclick="game.applyPrizeResultAssignment()"
                    style="
                      background: #667eea;
                      padding: 5px 10px;
                      font-size: 12px;
                    "
                  >
                    âœ“ Apply & Show Results
                  </button>
                </div>

                <!-- Result Assignments Display (Toggle) -->
                <div
                  id="resultAssignmentsDisplay"
                  style="
                    display: none;
                    margin-top: 10px;
                    padding: 10px;
                    background: rgba(0, 0, 0, 0.4);
                    border-radius: 5px;
                    border: 1px solid #667eea;
                    max-height: 200px;
                    overflow-y: auto;
                  "
                >
                  <div
                    style="
                      color: #667eea;
                      font-weight: bold;
                      margin-bottom: 5px;
                    "
                  >
                    ğŸ Result Assignments:
                  </div>
                  <div
                    id="resultAssignmentsContent"
                    style="color: #fff; font-size: 13px; line-height: 1.6"
                  ></div>
                </div>

                <small style="color: #888; margin-top: 8px; display: block"
                  >* Chá»n ngÆ°á»i nháº­n giáº£i tá»« danh sÃ¡ch "Victory History" Ä‘Ã£
                  lÆ°u.</small
                >
              </div>
            </div>
            <!-- Result Panel Background Settings -->
            <div class="input-group">
              <label for="resultBgType">Background Type:</label>
              <select
                id="resultBgType"
                onchange="game.toggleResultBackground()"
              >
                <option value="default">Default</option>
                <option value="color">Solid Color</option>
                <option value="image">Custom Image</option>
              </select>
            </div>

            <div
              class="input-group"
              id="resultBgColorGroup"
              style="display: none"
            >
              <label for="resultBgColor">Background Color:</label>
              <input type="color" id="resultBgColor" value="#1a1a2e" />
            </div>

            <div
              class="input-group"
              id="resultBgImageGroup"
              style="display: none"
            >
              <label for="resultBgImage">Background Image:</label>
              <input
                type="file"
                id="resultBgImage"
                accept="image/*"
                onchange="game.loadResultBackgroundImage(event)"
              />
              <small style="color: #888">Upload JPG, PNG, or GIF</small>
            </div>
            <div class="input-group">
              <button
                class="btn btn-small"
                onclick="game.applyResultPanelSettings()"
                style="background: #667eea; margin-right: 10px"
              >
                âœ“ Apply
              </button>
              <button
                class="btn btn-small"
                onclick="game.resetResultPanelSettings()"
                style="background: #888"
              >
                âŸ² Reset
              </button>
            </div>
            <!-- end layout settings -->
          </div>
        </div>
        <!-- end main panel settings container -->
      </div>
      <!-- end collapsible -->
    </div>
    <!-- end main panel settings -->
    <!-- Top N Victory Popup -->
    <div class="victory-popup" id="topNVictoryPopup">
      <div class="victory-overlay" onclick="game.closeTopNVictoryPopup()"></div>
      <div class="victory-content victory-content-topn">
        <div class="victory-header">
          <h1>ğŸ† TOP <span id="topNCount">N</span> WINNERS! ğŸ†</h1>
        </div>
        <div class="victory-body victory-body-topn" id="topNWinnersGrid">
          <!-- Winners will be populated here -->
        </div>
        <div class="victory-footer">
          <button
            class="btn btn-primary"
            onclick="
              game.closeTopNVictoryPopup();
              game.resetRace();
            "
          >
            â–¶ï¸ Next Race
          </button>
          <button
            class="btn btn-secondary"
            onclick="
              game.closeTopNVictoryPopup();
              game.fullReset();
            "
          >
            ğŸ”„ Play Again
          </button>
          <button
            class="btn btn-secondary"
            onclick="
              game.closeTopNVictoryPopup();
              game.showTopNResultPanel();
            "
          >
            ğŸ“‹ View Full Results
          </button>
        </div>
        <!-- end victory footer -->
      </div>
      <!-- end victory content -->
    </div>
    <!-- end top N victory popup -->

    <!-- Leaderboard -->
    <div class="history-win" id="historyWin">
      <h3>ğŸ† Victory History</h3>
      <div id="historyWinList"></div>
      <button
        class="btn btn-small"
        onclick="game.resetHistory()"
        style="margin-top: 10px; width: 100%"
      >
        ğŸ”„ Restart (Clear History)
      </button>
    </div>

    <!-- SheetJS library for Excel file support -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script type="module" src="game.js?v=61"></script>
    <script type="module">
      // ÄÄƒng nháº­p Ä‘Æ¡n giáº£n: chá»‰ cáº§n nháº­p username, lÆ°u vÃ o localStorage
      function showLogin() {
        document.getElementById("loginModal").style.display = "flex";
        document.getElementById("mainContent").style.display = "none";
      }
      function showMain() {
        document.getElementById("loginModal").style.display = "none";
        document.getElementById("mainContent").style.display = "";
        // Náº¿u lÃ  admin thÃ¬ hiá»ƒn thá»‹ adminPanel
        if (localStorage.getItem("lucky_racer_is_admin") === "1") {
          document.getElementById("adminPanel").style.display = "";
        } else {
          document.getElementById("adminPanel").style.display = "none";
        }
      }
      function isLoggedIn() {
        return !!localStorage.getItem("lucky_racer_user");
      }
      async function handleLogin() {
        var loginBtn = document.getElementById("loginBtn");
        var spinner = document.getElementById("loginLoadingSpinner");
        loginBtn.disabled = true;
        loginBtn.style.opacity = 0.7;
        spinner.style.display = "inline-block";
        var username = document.getElementById("loginUsername").value.trim();
        var password = document.getElementById("loginPassword").value;
        var isAdmin = document.getElementById("isAdmin").checked;
        var errorDiv = document.getElementById("loginError");
        errorDiv.style.display = "none";
        if (!username || !password) {
          errorDiv.textContent = "Vui lÃ²ng nháº­p tÃªn Ä‘Äƒng nháº­p vÃ  máº­t kháº©u!";
          errorDiv.style.display = "block";
          loginBtn.disabled = false;
          loginBtn.style.opacity = 1;
          spinner.style.display = "none";
          return;
        }
        // Láº¥y danh sÃ¡ch account tá»« API
        const GSHEET_API = "/api/gsheet-proxy";
        let accounts = [];
        try {
          let res = await fetch(GSHEET_API);
          accounts = await res.json();
        } catch (e) {
          errorDiv.textContent = "KhÃ´ng thá»ƒ káº¿t ná»‘i server!";
          errorDiv.style.display = "block";
          loginBtn.disabled = false;
          loginBtn.style.opacity = 1;
          spinner.style.display = "none";
          return;
        }
        var now = Date.now();
        // Náº¿u lÃ  admin: chá»‰ cho phÃ©p Ä‘Äƒng nháº­p Ä‘Ãºng account visionx/admin123
        if (isAdmin) {
          let found = accounts.find(
            (acc) => acc.username === "visionx" && acc.password === "admin123",
          );
          if (!found) {
            errorDiv.textContent = "KhÃ´ng tÃ¬m tháº¥y tÃ i khoáº£n admin!";
            errorDiv.style.display = "block";
            loginBtn.disabled = false;
            loginBtn.style.opacity = 1;
            spinner.style.display = "none";
            return;
          }
          if (username !== "visionx" || password !== "admin123") {
            errorDiv.textContent = "Sai tÃ i khoáº£n hoáº·c máº­t kháº©u admin!";
            errorDiv.style.display = "block";
            loginBtn.disabled = false;
            loginBtn.style.opacity = 1;
            spinner.style.display = "none";
            return;
          }
          localStorage.setItem("lucky_racer_user", username);
          localStorage.setItem("lucky_racer_is_admin", "1");
          loginBtn.disabled = false;
          loginBtn.style.opacity = 1;
          spinner.style.display = "none";
          showMain();
          return;
        }
        // ÄÄƒng nháº­p thÆ°á»ng: kiá»ƒm tra account há»£p lá»‡, trong thá»i gian hiá»‡u lá»±c
        let found = accounts.find(
          (acc) =>
            acc.username === username &&
            acc.password === password &&
            now >= acc.active &&
            now <= acc.revoke,
        );
        if (!found) {
          errorDiv.textContent =
            "Sai tÃ i khoáº£n, máº­t kháº©u hoáº·c tÃ i khoáº£n Ä‘Ã£ háº¿t háº¡n!";
          errorDiv.style.display = "block";
          loginBtn.disabled = false;
          loginBtn.style.opacity = 1;
          spinner.style.display = "none";
          return;
        }
        localStorage.setItem("lucky_racer_user", username);
        localStorage.removeItem("lucky_racer_is_admin");
        loginBtn.disabled = false;
        loginBtn.style.opacity = 1;
        spinner.style.display = "none";
        showMain();
        // Khá»Ÿi táº¡o game náº¿u cáº§n
        if (typeof game !== "undefined") {
          game.loadSavedData && game.loadSavedData();
          game.loadPrizeNames && game.loadPrizeNames();
          game.renderPrizeRaceUI && game.renderPrizeRaceUI();
          game.renderPrizeAssignmentUI && game.renderPrizeAssignmentUI();
          game.loadResultPanelSettings && game.loadResultPanelSettings();
        }
      }
      // HÃ m sinh máº­t kháº©u ngáº«u nhiÃªn
      function generatePassword(length = 10) {
        const chars =
          "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%^&*";
        let pass = "";
        for (let i = 0; i < length; i++) {
          pass += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return pass;
      }

      // Há»£p nháº¥t sá»± kiá»‡n DOMContentLoaded Ä‘á»ƒ kiá»ƒm soÃ¡t hiá»ƒn thá»‹ giao diá»‡n vÃ  gÃ¡n sá»± kiá»‡n
      window.addEventListener("DOMContentLoaded", function () {
        // Sá»± kiá»‡n show/hide password cho login
        const showLoginPw = document.getElementById("showLoginPassword");
        if (showLoginPw) {
          showLoginPw.addEventListener("change", function () {
            const pwInput = document.getElementById("loginPassword");
            if (pwInput) pwInput.type = this.checked ? "text" : "password";
          });
        }
        // Sá»± kiá»‡n show/hide password cho admin panel
        const showNewPw = document.getElementById("showNewPassword");
        if (showNewPw) {
          showNewPw.addEventListener("change", function () {
            const pwInput = document.getElementById("newPassword");
            if (pwInput) pwInput.type = this.checked ? "text" : "password";
          });
        }
        // áº¨n cáº£ hai giao diá»‡n trÆ°á»›c khi kiá»ƒm tra
        document.getElementById("loginModal").style.display = "none";
        document.getElementById("mainContent").style.display = "none";

        // LuÃ´n yÃªu cáº§u Ä‘Äƒng nháº­p má»—i láº§n truy cáº­p
        localStorage.removeItem("lucky_racer_user");
        localStorage.removeItem("lucky_racer_is_admin");
        showLogin();
        document.getElementById("loginBtn").onclick = handleLogin;
        document
          .getElementById("loginUsername")
          .addEventListener("keydown", function (e) {
            if (e.key === "Enter") handleLogin();
          });
        // Sá»± kiá»‡n cho nÃºt generate máº­t kháº©u (chá»‰ khi lÃ  admin)
        const genBtn = document.getElementById("genPassBtn");
        if (genBtn) {
          genBtn.onclick = function () {
            const pw = generatePassword(12);
            document.getElementById("genPassResult").textContent = pw;
          };
        }

        // Admin panel: quáº£n lÃ½ tÃ i khoáº£n
        async function renderAccountList() {
          let html = "<b>Danh sÃ¡ch tÃ i khoáº£n:</b><br>";
          let accounts = [];
          try {
            let res = await fetch(GSHEET_API);
            accounts = await res.json();
          } catch (e) {
            html +=
              '<span style="color:#ff7675">KhÃ´ng thá»ƒ táº£i danh sÃ¡ch tÃ i khoáº£n!</span>';
            document.getElementById("accountList").innerHTML = html;
            return;
          }
          if (accounts.length === 0) {
            html += "<i>ChÆ°a cÃ³ tÃ i khoáº£n nÃ o.</i>";
          } else {
            html += '<ul style="padding-left:18px;">';
            accounts.forEach(function (item, idx) {
              var activeStr = new Date(item.active).toLocaleString();
              var revokeStr = new Date(item.revoke).toLocaleString();
              var expired = Date.now() > item.revoke;
              html += `<li><span style="color:${expired ? "#ff7675" : "#00b894"}">${item.username}</span> <span style="font-size:13px;">(Hiá»‡u lá»±c: ${activeStr} - ${revokeStr})</span> <button onclick="removeAccount('${item.username}')" style="color:#fff;background:#e17055;border:none;border-radius:4px;padding:2px 8px;margin-left:8px;cursor:pointer;">XÃ³a</button></li>`;
            });
            html += "</ul>";
          }
          document.getElementById("accountList").innerHTML = html;
        }
        window.removeAccount = async function (username) {
          const params = new URLSearchParams();
          params.append("action", "delete");
          params.append("username", username);
          await fetch(GSHEET_API, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: params.toString(),
          });
          renderAccountList();
        };
        // Module gá»­i dá»¯ liá»‡u táº¡o tÃ i khoáº£n lÃªn Google Script
        async function createAccountOnGSheet({
          username,
          password,
          activeMs,
          revokeMs,
        }) {
          // Gá»­i trá»±c tiáº¿p lÃªn Google Script Web App (bá» qua proxy náº¿u cáº§n)
          const GSHEET_WEBAPP =
            "https://script.google.com/macros/s/AKfycbxo289V3Ky97PwhyW5INpfefEaw_LRwb90mbmBVtUNYIIxMphJ8plKTD8P7RnUmRsRm/exec";
          const params = new URLSearchParams();
          params.append("username", username);
          params.append("password", password);
          params.append("active", activeMs);
          params.append("revoke", revokeMs);
          try {
            let res = await fetch(GSHEET_WEBAPP, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: params.toString(),
            });
            let data = await res.json();
            return data;
          } catch (e) {
            return { error: "Lá»—i káº¿t ná»‘i server!" };
          }
        }

        var addForm = document.getElementById("addAccountForm");
        if (addForm) {
          addForm.onsubmit = async function (e) {
            e.preventDefault();
            var username = document.getElementById("newUsername").value.trim();
            var pw = document.getElementById("newPassword").value.trim();
            // Báº¯t buá»™c máº­t kháº©u pháº£i báº¯t Ä‘áº§u báº±ng chá»¯ cÃ¡i (khÃ´ng Ä‘Æ°á»£c báº¯t Ä‘áº§u báº±ng sá»‘)
            if (!/^[A-Za-z]/.test(pw)) {
              alert(
                "Máº­t kháº©u pháº£i báº¯t Ä‘áº§u báº±ng kÃ½ tá»± chá»¯ cÃ¡i (khÃ´ng Ä‘Æ°á»£c báº¯t Ä‘áº§u báº±ng sá»‘)!",
              );
              return;
            }
            // Sá»± kiá»‡n show/hide password cho login
            const showLoginPw = document.getElementById("showLoginPassword");
            if (showLoginPw) {
              showLoginPw.addEventListener("change", function () {
                const pwInput = document.getElementById("loginPassword");
                pwInput.type = this.checked ? "text" : "password";
              });
            }
            // Sá»± kiá»‡n show/hide password cho admin panel
            const showNewPw = document.getElementById("showNewPassword");
            if (showNewPw) {
              showNewPw.addEventListener("change", function () {
                const pwInput = document.getElementById("newPassword");
                pwInput.type = this.checked ? "text" : "password";
              });
            }
            var active = document.getElementById("activeTime").value;
            var revoke = document.getElementById("revokeTime").value;
            if (!username || !pw || !active || !revoke) {
              alert(
                "Vui lÃ²ng nháº­p Ä‘á»§ tÃ i khoáº£n, máº­t kháº©u, thá»i gian hiá»‡u lá»±c vÃ  thu há»“i!",
              );
              return;
            }
            var activeMs = new Date(active).getTime();
            var revokeMs = new Date(revoke).getTime();
            console.log("DEBUG gá»­i lÃªn:", {
              username,
              password: pw,
              active,
              revoke,
              activeMs,
              revokeMs,
            });
            if (
              !active ||
              !revoke ||
              isNaN(activeMs) ||
              isNaN(revokeMs) ||
              activeMs >= revokeMs
            ) {
              alert("Thá»i gian khÃ´ng há»£p lá»‡!");
              return;
            }
            // Gá»i module gá»­i dá»¯ liá»‡u
            let data = await createAccountOnGSheet({
              username,
              password: pw,
              activeMs,
              revokeMs,
            });
            if (data.success) {
              alert("ThÃªm tÃ i khoáº£n thÃ nh cÃ´ng!");
            } else {
              alert("Lá»—i: " + (data.error || "KhÃ´ng rÃµ nguyÃªn nhÃ¢n"));
            }
            document.getElementById("newUsername").value = "";
            document.getElementById("newPassword").value = "";
            document.getElementById("activeTime").value = "";
            document.getElementById("revokeTime").value = "";
            renderAccountList();
          };
        }
        // Hiá»ƒn thá»‹ danh sÃ¡ch tÃ i khoáº£n khi vÃ o admin panel
        if (localStorage.getItem("lucky_racer_is_admin") === "1") {
          renderAccountList();
        }
        // Khi chuyá»ƒn sang admin, tá»± Ä‘á»™ng render láº¡i danh sÃ¡ch
        window.showMain = (function (orig) {
          return function () {
            orig();
            if (localStorage.getItem("lucky_racer_is_admin") === "1") {
              renderAccountList();
            }
          };
        })(window.showMain);
      });

      // Initialize simplified prize UI after game loads
      setTimeout(() => {
        if (window.game && game.renderSimplePrizeUI) {
          game.renderSimplePrizeUI();
        }
      }, 500);
    </script>
  </body>
</html>
